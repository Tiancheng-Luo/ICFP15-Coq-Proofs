<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>semantics</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library semantics</h1>

<div class="code">
<span class="id" title="keyword">Set Implicit Arguments</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">heap</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">Omega</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">hetList</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">Coq.Program.Equality</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">Coq.Sets.Ensembles</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab2"></a><h1 class="section">Evaluation contexts</h1>

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">decompose</span> : <span class="id" title="var">term</span> -&gt; <span class="id" title="var">ctxt</span> -&gt; <span class="id" title="var">term</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">decompApp</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">e1</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">app</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span>) (<span class="id" title="var">appCtxt</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span>) <span class="id" title="var">e</span><br/>
|<span class="id" title="var">decompAppVal</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">v</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> (<span class="id" title="var">prf</span>:<span class="id" title="var">value</span> <span class="id" title="var">v</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <span class="id" title="var">decompose</span> (<span class="id" title="var">app</span> <span class="id" title="var">v</span> <span class="id" title="var">e2</span>) (<span class="id" title="var">appValCtxt</span> <span class="id" title="var">v</span> <span class="id" title="var">prf</span> <span class="id" title="var">E</span>) <span class="id" title="var">e</span><br/>
|<span class="id" title="var">appHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span> <span class="id" title="var">v</span>, <span class="id" title="var">value</span> <span class="id" title="var">v</span> -&gt; <span class="id" title="var">decompose</span> (<span class="id" title="var">app</span> (<span class="id" title="var">lambda</span> <span class="id" title="var">e</span>) <span class="id" title="var">v</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">app</span> (<span class="id" title="var">lambda</span> <span class="id" title="var">e</span>) <span class="id" title="var">v</span>)<br/>
|<span class="id" title="var">decompGet</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span> <span class="id" title="var">E</span> <span class="id" title="var">e'</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">e</span> <span class="id" title="var">E</span> <span class="id" title="var">e'</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">get</span> <span class="id" title="var">e</span>) (<span class="id" title="var">getCtxt</span> <span class="id" title="var">E</span>) <span class="id" title="var">e'</span><br/>
|<span class="id" title="var">decompGetHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">l</span>, <span class="id" title="var">decompose</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) <span class="id" title="var">hole</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>))<br/>
|<span class="id" title="var">decompPut</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">e1</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">put</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span>) (<span class="id" title="var">putCtxt</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span>) <span class="id" title="var">e</span><br/>
|<span class="id" title="var">decompPutVal</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">v</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> (<span class="id" title="var">prf</span>:<span class="id" title="var">value</span> <span class="id" title="var">v</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">e2</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">put</span> <span class="id" title="var">v</span> <span class="id" title="var">e2</span>) (<span class="id" title="var">putValCtxt</span> <span class="id" title="var">v</span> <span class="id" title="var">prf</span> <span class="id" title="var">E</span>) <span class="id" title="var">e</span><br/>
|<span class="id" title="var">decompPutHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">n</span> <span class="id" title="var">v</span>, <span class="id" title="var">value</span> <span class="id" title="var">v</span> -&gt; <span class="id" title="var">decompose</span> (<span class="id" title="var">put</span> (<span class="id" title="var">loc</span> <span class="id" title="var">n</span>) <span class="id" title="var">v</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">put</span> (<span class="id" title="var">loc</span> <span class="id" title="var">n</span>) <span class="id" title="var">v</span>)<br/>
|<span class="id" title="var">decompAlloc</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span> <span class="id" title="var">E</span> <span class="id" title="var">e'</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">e</span> <span class="id" title="var">E</span> <span class="id" title="var">e'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">alloc</span> <span class="id" title="var">e</span>) (<span class="id" title="var">allocCtxt</span> <span class="id" title="var">E</span>) <span class="id" title="var">e'</span><br/>
|<span class="id" title="var">decompAllocHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">v</span>, <span class="id" title="var">value</span> <span class="id" title="var">v</span> -&gt; <span class="id" title="var">decompose</span> (<span class="id" title="var">alloc</span> <span class="id" title="var">v</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">alloc</span> <span class="id" title="var">v</span>)<br/>
|<span class="id" title="var">decompAtomicHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span>, <span class="id" title="var">decompose</span> (<span class="id" title="var">atomic</span> <span class="id" title="var">e</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">atomic</span> <span class="id" title="var">e</span>)<br/>
|<span class="id" title="var">decompFork</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span>, <span class="id" title="var">decompose</span> (<span class="id" title="var">fork</span> <span class="id" title="var">e</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">fork</span> <span class="id" title="var">e</span>)<br/>
|<span class="id" title="var">decompInAtomic</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">e</span> <span class="id" title="var">e'</span> <span class="id" title="var">E</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">e</span> <span class="id" title="var">E</span> <span class="id" title="var">e'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> (<span class="id" title="var">inatomic</span> <span class="id" title="var">e</span>) (<span class="id" title="var">inatomicCtxt</span> <span class="id" title="var">E</span>) <span class="id" title="var">e'</span><br/>
|<span class="id" title="var">decompInAtomicHole</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">v</span>, <span class="id" title="var">value</span> <span class="id" title="var">v</span> -&gt; <span class="id" title="var">decompose</span> (<span class="id" title="var">inatomic</span> <span class="id" title="var">v</span>) <span class="id" title="var">hole</span> (<span class="id" title="var">inatomic</span> <span class="id" title="var">v</span>).<br/>

<br/>
</div>

<div class="doc">
Values cannot be decomposed
</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">decomposeValFalse</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>, <span class="id" title="var">value</span> <span class="id" title="var">t</span> -&gt; <span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <span class="id" title="var">False</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">v</span> <span class="id" title="var">d</span>. <span class="id" title="var">inv</span> <span class="id" title="var">d</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span>[<span class="id" title="var">inv</span> <span class="id" title="var">v</span>].<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">decompVal</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">value</span> ?<span class="id" title="var">t</span>, <span class="id" title="var">H'</span>:<span class="id" title="var">decompose</span> ?<span class="id" title="var">t</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">e</span> |- <span class="id" title="var">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">decomposeValFalse</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H'</span>; <span class="id" title="tactic">auto</span>; <span class="id" title="var">inv</span> <span class="id" title="var">H'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">lambda</span> ?<span class="id" title="var">e</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">loc</span> ?<span class="id" title="var">l</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">invertDecomp</span> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">app</span> ?<span class="id" title="var">e1</span> ?<span class="id" title="var">e2</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">get</span> ?<span class="id" title="var">e</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">put</span> ?<span class="id" title="var">e1</span> ?<span class="id" title="var">e2</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">alloc</span> ?<span class="id" title="var">e</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">fork</span> ?<span class="id" title="var">e</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">e'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> (<span class="id" title="var">inatomic</span> ?<span class="id" title="var">e</span>) ?<span class="id" title="var">E</span> ?<span class="id" title="var">E'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Evaluation context decomposition is deterministic
</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">decomposeDeterministic</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">E'</span> <span class="id" title="var">e</span> <span class="id" title="var">e'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E'</span> <span class="id" title="var">e'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">E</span> = <span class="id" title="var">E'</span> /\ <span class="id" title="var">e</span> = <span class="id" title="var">e'</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">E'</span> <span class="id" title="var">e</span> <span class="id" title="var">e'</span> <span class="id" title="var">HD1</span> <span class="id" title="var">HD2</span>. <span class="id" title="var">genDeps</span> {{ <span class="id" title="var">E'</span>; <span class="id" title="var">e'</span>}}.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">HD1</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">try</span>(<span class="id" title="var">invertDecomp</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">decompVal</span>); <span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span>[<span class="id" title="tactic">auto</span> |<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="keyword">forall</span> <span class="id" title="var">e'0</span> <span class="id" title="var">E'</span>, <span class="id" title="var">decompose</span> ?<span class="id" title="var">e</span> <span class="id" title="var">E'</span> <span class="id" title="var">e'0</span> -&gt; ?<span class="id" title="var">E</span> = <span class="id" title="var">E'</span> /\ ?<span class="id" title="var">e'</span> = <span class="id" title="var">e'0</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H'</span>:<span class="id" title="var">decompose</span> ?<span class="id" title="var">e</span> ?<span class="id" title="var">E''</span> ?<span class="id" title="var">e''</span> |- <span class="id" title="var">_</span> =&gt;  <span class="id" title="tactic">apply</span> <span class="id" title="var">H</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H'</span>; <span class="id" title="var">invertHyp</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="tactic">try</span> (<span class="id" title="var">proofsEq</span>; <span class="id" title="tactic">eauto</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>].<br/>
&nbsp;&nbsp;<span class="id" title="var">inv</span> <span class="id" title="var">HD2</span>. <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">decompSame</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">H</span>:<span class="id" title="var">decompose</span> ?<span class="id" title="var">t</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">e</span>,<span class="id" title="var">H'</span>:<span class="id" title="var">decompose</span> ?<span class="id" title="var">t</span> ?<span class="id" title="var">E'</span> ?<span class="id" title="var">e'</span> |- <span class="id" title="var">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> <span class="id" title="var">decomposeDeterministic</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">fill</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctxt</span>) (<span class="id" title="var">e</span>:<span class="id" title="var">term</span>) := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">appCtxt</span> <span class="id" title="var">e'</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">app</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>) <span class="id" title="var">e'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">appValCtxt</span> <span class="id" title="var">v</span> <span class="id" title="var">_</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">app</span> <span class="id" title="var">v</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">getCtxt</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">get</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">putCtxt</span> <span class="id" title="var">e'</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">put</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>) <span class="id" title="var">e'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">putValCtxt</span> <span class="id" title="var">v</span> <span class="id" title="var">_</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">put</span> <span class="id" title="var">v</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">allocCtxt</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">alloc</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">inatomicCtxt</span> <span class="id" title="var">E</span> =&gt; <span class="id" title="var">inatomic</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">hole</span> =&gt; <span class="id" title="var">e</span> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">commit</span></span> <span class="inlinecode"><span class="id" title="var">chkpnt</span></span> <span class="inlinecode"><span class="id" title="var">HI</span></span> <span class="inlinecode"><span class="id" title="var">HV</span></span>

<div class="paragraph"> </div>

<ul class="doclist">
<li>indicates the log is valid 

</li>
<li><span class="inlinecode"><span class="id" title="var">chkpnt</span></span> is used in the event we later find an out of date read without a checkpoint

</li>
<li><span class="inlinecode"><span class="id" title="var">HI</span></span> has writes undone in case we later find a violation (invalid heap)

</li>
<li><span class="inlinecode"><span class="id" title="var">HV</span></span> keeps values in place but releases locks (valid heap)

</li>
</ul>
<span class="inlinecode"><span class="id" title="var">abort</span></span> <span class="inlinecode">(<span class="id" title="var">e</span>,</span> <span class="inlinecode"><span class="id" title="var">L</span>)</span> <span class="inlinecode"><span class="id" title="var">HI</span></span>

<div class="paragraph"> </div>

<ul class="doclist">
<li>indicates validation failed

</li>
<li>resume with term <span class="inlinecode"><span class="id" title="var">e</span></span> and log <span class="inlinecode"><span class="id" title="var">L</span></span>

</li>
<li><span class="inlinecode"><span class="id" title="var">HI</span></span> contains the same heap but with locks released that came after the violation

</li>
</ul>

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">validateRes</span> : <span class="id" title="keyword">Type</span> := <br/>
|<span class="id" title="var">commit</span> : <span class="id" title="var">chkpnt</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">validateRes</span> <br/>
|<span class="id" title="var">abort</span> : <span class="id" title="var">chkpnt</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">validateRes</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">invalidHeap</span> <span class="id" title="var">res</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">res</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">commit</span> <span class="id" title="var">_</span> <span class="id" title="var">H</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">abort</span> <span class="id" title="var">_</span> <span class="id" title="var">H</span> =&gt; <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">invalidStamp</span> (<span class="id" title="var">tid</span> : <span class="id" title="var">nat</span>) (<span class="id" title="var">rv</span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">lock</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
| <span class="id" title="var">StampStale</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">s</span>, <span class="id" title="var">rv</span> &lt; <span class="id" title="var">s</span> -&gt; <span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">s</span>)<br/>
| <span class="id" title="var">StampLocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">s</span> <span class="id" title="var">v</span> <span class="id" title="var">s'</span>, <span class="id" title="var">s</span> &lt;&gt; <span class="id" title="var">tid</span> -&gt; <span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Locked</span> <span class="id" title="var">s</span> <span class="id" title="var">s'</span> <span class="id" title="var">v</span>).<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">validStamp</span> (<span class="id" title="var">tid</span> : <span class="id" title="var">nat</span>) (<span class="id" title="var">rv</span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">lock</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
| <span class="id" title="var">LockOwned</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">s'</span> <span class="id" title="var">v</span>, <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">s'</span> <span class="id" title="var">v</span>)<br/>
| <span class="id" title="var">StampFresh</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">s</span>, <span class="id" title="var">rv</span> &gt;= <span class="id" title="var">s</span> -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">s</span>).<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">validInvalidStamp</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt; <span class="id" title="var">False</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> <span class="id" title="var">H</span> <span class="id" title="var">H0</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="var">inv</span> <span class="id" title="var">H0</span>; <span class="id" title="tactic">auto</span>. <span class="id" title="tactic">omega</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">readTail</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span>, <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">cTail</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">E</span> <span class="id" title="var">L</span>, <span class="id" title="var">readTail</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">L</span><br/>
|<span class="id" title="var">rTail</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>, <span class="id" title="var">readTail</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">L</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab3"></a><h1 class="section">Transactional log validation</h1>


<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">tid</span></span>: thread ID of validating thread

</li>
<li> <span class="inlinecode"><span class="id" title="var">rv</span></span>, <span class="inlinecode"><span class="id" title="var">wv</span></span>: read version / write version 

</li>
<li> <span class="inlinecode"><span class="id" title="var">e0</span></span>: initial transaction term (in case of full abort)

</li>
<li> <span class="inlinecode"><span class="id" title="var">b</span></span>: indicates if a write exists in the log

</li>
</ul>
Rules:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">validNil</span></span>: empty log is trivially valid

</li>
<li> <span class="inlinecode"><span class="id" title="var">validChkpnt</span></span>: a checkpointed read is valid, if the tail is valid and lock corresponding is either owned, or is unlocked and older than read version.

</li>
<li> <span class="inlinecode"><span class="id" title="var">invalidChkpnt</span></span>: If the tail is valid, but the location read from is out of date or locked by someone else, then initiate an abort

</li>
<li> <span class="inlinecode"><span class="id" title="var">validRead</span></span>: analogous to <span class="inlinecode"><span class="id" title="var">validChkpnt</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">invalidRead</span></span>: analogous to <span class="inlinecode"><span class="id" title="var">invalidChkpnt</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">validWrite</span></span>: The location written must be acquired by <span class="inlinecode"><span class="id" title="var">tid</span></span>.  We also enforce that <span class="inlinecode"><span class="id" title="var">rv</span></span> <span class="inlinecode">&gt;=</span> <span class="inlinecode"><span class="id" title="var">oldV</span></span> and <span class="inlinecode"><span class="id" title="var">Log.notIn</span></span> <span class="inlinecode"><span class="id" title="var">l</span></span> <span class="inlinecode"><span class="id" title="var">b</span></span> <span class="inlinecode"><span class="id" title="var">L</span></span>.  This is not strictly necessary, but makes the proofs easier later on.  This doesn't impose any restrictions on the semantics.  

</li>
<li> <span class="inlinecode"><span class="id" title="var">readPropAbort</span></span>: propogate an abort

</li>
<li> <span class="inlinecode"><span class="id" title="var">writePropAbort</span></span>: propogate an abort at a write.  We must also unlocked the appropriate location.
 
</li>
</ul>

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">validate</span> (<span class="id" title="var">tid</span> : <span class="id" title="var">nat</span>) (<span class="id" title="var">rv</span> <span class="id" title="var">wv</span> : <span class="id" title="var">nat</span>) (<span class="id" title="var">e0</span> : <span class="id" title="var">term</span>) : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span>, <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">validateRes</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">validNil</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span>, <span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">NilLog</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> (<span class="id" title="var">e0</span>, <span class="id" title="var">NilLog</span>) <span class="id" title="var">H</span> <span class="id" title="var">H</span>)<br/>
|<span class="id" title="var">validChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">lock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">E</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">L</span> <span class="id" title="var">chkpnt</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HV</span> <span class="id" title="var">HI</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)), <span class="id" title="var">L</span>) <span class="id" title="var">HV</span> <span class="id" title="var">HI</span>)<br/>
|<span class="id" title="var">invalidChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">lock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">E</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">L</span> <span class="id" title="var">chkpnt</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)), <span class="id" title="var">L</span>) <span class="id" title="var">HI</span>)<br/>
|<span class="id" title="var">validRead</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">lock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">L</span> <span class="id" title="var">chkpnt</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>)<br/>
|<span class="id" title="var">invalidRead</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">lock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">L</span> <span class="id" title="var">chkpnt</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span>)<br/>
|<span class="id" title="var">validWrite</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">b</span> (<span class="id" title="var">L</span> : <span class="id" title="var">log</span> <span class="id" title="var">b</span>) <span class="id" title="var">chkpnt</span> <span class="id" title="var">oldV</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v'</span>) -&gt; <span class="id" title="var">rv</span> &gt;= <span class="id" title="var">oldV</span> -&gt; <span class="id" title="var">Log.notIn</span> <span class="id" title="var">l</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Write</span> <span class="id" title="var">b</span> <span class="id" title="var">l</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> (<span class="id" title="var">update</span> <span class="id" title="var">HI</span> <span class="id" title="var">l</span> <span class="id" title="var">v'</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">oldV</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">update</span> <span class="id" title="var">HV</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">wv</span>)))<br/>
|<span class="id" title="var">readPropAbort</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">H</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">L</span> <span class="id" title="var">L'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L'</span> <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">readTail</span> <span class="id" title="var">L</span> <span class="id" title="var">L'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span>)<br/>
|<span class="id" title="var">writePropAbort</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">b</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">oldV</span> <span class="id" title="var">L</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v'</span>) -&gt; <span class="id" title="var">Log.notIn</span> <span class="id" title="var">l</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> -&gt; <span class="id" title="var">rv</span> &gt;= <span class="id" title="var">oldV</span> -&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">wv</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Write</span> <span class="id" title="var">b</span> <span class="id" title="var">l</span> <span class="id" title="var">L</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">abort</span> <span class="id" title="var">chkpnt</span> (<span class="id" title="var">update</span> <span class="id" title="var">HI</span> <span class="id" title="var">l</span> <span class="id" title="var">v'</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">oldV</span>))).<br/>

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">invertHyp</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">readTail</span> (<span class="id" title="var">Chkpnt</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">L'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">readTail</span> (<span class="id" title="var">Read</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">L'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">readTail</span> (<span class="id" title="var">Write</span> ?<span class="id" title="var">b</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">L'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">readTail</span> <span class="id" title="var">NilLog</span> ?<span class="id" title="var">L'</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">validate</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">S</span> ?<span class="id" title="var">C</span> ?<span class="id" title="var">e0</span> (<span class="id" title="var">Read</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">H0</span> ?<span class="id" title="var">res</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">validate</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">S</span> ?<span class="id" title="var">C</span> ?<span class="id" title="var">e0</span> (<span class="id" title="var">Chkpnt</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">H0</span> ?<span class="id" title="var">res</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">validate</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">S</span> ?<span class="id" title="var">C</span> ?<span class="id" title="var">e0</span> (<span class="id" title="var">Write</span> ?<span class="id" title="var">b</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">L</span>) ?<span class="id" title="var">H0</span> ?<span class="id" title="var">res</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">validate</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">S</span> ?<span class="id" title="var">C</span> ?<span class="id" title="var">e0</span> <span class="id" title="var">NilLog</span> ?<span class="id" title="var">H0</span> ?<span class="id" title="var">res</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.notIn</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">b</span> (<span class="id" title="var">Chkpnt</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.notIn</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">b</span> (<span class="id" title="var">Read</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.notIn</span> ?<span class="id" title="var">l</span> ?<span class="id" title="var">b</span> (<span class="id" title="var">Write</span> ?<span class="id" title="var">b'</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.In</span> ?<span class="id" title="var">l</span> (<span class="id" title="var">Chkpnt</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">E</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.In</span> ?<span class="id" title="var">l</span> (<span class="id" title="var">Read</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">v</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">Log.In</span> ?<span class="id" title="var">l</span> (<span class="id" title="var">Write</span> ?<span class="id" title="var">b'</span> ?<span class="id" title="var">l'</span> ?<span class="id" title="var">L</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="tactic">dependent</span> <span class="id" title="tactic">destruction</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">locked</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">lock</span> |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">invalidStamp</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">rv</span> (<span class="id" title="var">Locked</span> ?<span class="id" title="var">tid'</span> ?<span class="id" title="var">oldV</span> ?<span class="id" title="var">v</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;|<span class="id" title="var">H</span> : <span class="id" title="var">invalidStamp</span> ?<span class="id" title="var">tid</span> ?<span class="id" title="var">rv</span> (<span class="id" title="var">Unlocked</span> ?<span class="id" title="var">v</span>) |- <span class="id" title="var">_</span> =&gt; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">invertHyp</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">tactics.invertHyp</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">open</span> (<span class="id" title="var">e</span>:<span class="id" title="var">term</span>) (<span class="id" title="var">k</span>:<span class="id" title="var">nat</span>) (<span class="id" title="var">e'</span>:<span class="id" title="var">term</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">lambda</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">lambda</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> (<span class="id" title="var">S</span> <span class="id" title="var">k</span>) <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">loc</span> <span class="id" title="var">l</span> =&gt; <span class="id" title="var">loc</span> <span class="id" title="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">unit</span> =&gt; <span class="id" title="var">unit</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">var</span> <span class="id" title="var">k'</span> =&gt; <span class="id" title="keyword">if</span> <span class="id" title="var">eq_nat_dec</span> <span class="id" title="var">k</span> <span class="id" title="var">k'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">e'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">var</span> <span class="id" title="var">k'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">app</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span> =&gt; <span class="id" title="var">app</span> (<span class="id" title="var">open</span> <span class="id" title="var">e1</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>) (<span class="id" title="var">open</span> <span class="id" title="var">e2</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">get</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">get</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">put</span> <span class="id" title="var">e1</span> <span class="id" title="var">e2</span> =&gt; <span class="id" title="var">put</span> (<span class="id" title="var">open</span> <span class="id" title="var">e1</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>) (<span class="id" title="var">open</span> <span class="id" title="var">e2</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">alloc</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">alloc</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">fork</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">fork</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">atomic</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">atomic</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id" title="var">inatomic</span> <span class="id" title="var">e</span> =&gt; <span class="id" title="var">inatomic</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> <span class="id" title="var">k</span> <span class="id" title="var">e'</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">acquireLock</span> (<span class="id" title="var">l</span> : <span class="id" title="var">location</span>) (<span class="id" title="var">v</span> : <span class="id" title="var">term</span>) (<span class="id" title="var">tid</span> <span class="id" title="var">rv</span> : <span class="id" title="var">nat</span>) : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span>, <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="var">lock</span> -&gt; <span class="id" title="var">lock</span> -&gt; <span class="id" title="var">log</span> <span class="id" title="var">true</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
| <span class="id" title="var">acquireLocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">L</span> <span class="id" title="var">oldV</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Log.In</span> <span class="id" title="var">l</span> <span class="id" title="var">L</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">acquireLock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">L</span> (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span>) (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span>) <span class="id" title="var">L</span>    <br/>
| <span class="id" title="var">acquireUnlocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">S'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rv</span> &gt;= <span class="id" title="var">S'</span> -&gt; <span class="id" title="var">Log.notIn</span> <span class="id" title="var">l</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">acquireLock</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">tid</span> <span class="id" title="var">rv</span> <span class="id" title="var">L</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">S'</span>) (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">S'</span> <span class="id" title="var">v</span>) (<span class="id" title="var">Write</span> <span class="id" title="var">b</span> <span class="id" title="var">l</span> <span class="id" title="var">L</span>).<br/>

<br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<a name="lab4"></a><h1 class="section">Transactional Steps</h1>


<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">t_readChkpnt</span></span>: A checkpointed read can occur if there are no writes in the log and if the associated lock is valid (owned or unlocked and older than <span class="inlinecode"><span class="id" title="var">rv</span></span>).

</li>
<li> <span class="inlinecode"><span class="id" title="var">t_readNoChkpnt</span></span>: Valid read without a checkpoint (we already have written something).

</li>
<li> <span class="inlinecode"><span class="id" title="var">t_writeLocked</span></span>: write to the location if we can acquire the lock.  Either we already own it, or it is unlocked and older than our read version.

</li>
<li> <span class="inlinecode"><span class="id" title="var">t_atomicIdemStep</span></span>: nested transactions are idempotent

</li>
<li> <span class="inlinecode"><span class="id" title="var">t_betaStep</span></span>: beta reduction within a transaction.

</li>
</ul>

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">trans_step</span> : <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">t_readChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">S</span> (<span class="id" title="var">L</span> : <span class="id" title="var">log</span> <span class="id" title="var">false</span>) <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">v</span> <span class="id" title="var">e0</span> <span class="id" title="var">lock</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span>))<br/>
|<span class="id" title="var">t_readNoChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">v</span> <span class="id" title="var">e0</span> <span class="id" title="var">lock</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span>))<br/>
|<span class="id" title="var">t_writeLocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">tid</span> <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">L'</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">e0</span> <span class="id" title="var">H</span> <span class="id" title="var">lock</span> <span class="id" title="var">lock'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">put</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>) <span class="id" title="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">acquireLock</span> <span class="id" title="var">l</span> <span class="id" title="var">v'</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">lock</span> <span class="id" title="var">lock'</span> <span class="id" title="var">L'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) (<span class="id" title="var">update</span> <span class="id" title="var">H</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">lock'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L'</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">unit</span>))<br/>
|<span class="id" title="var">t_atomicIdemStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">atomic</span> <span class="id" title="var">e</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>))<br/>
|<span class="id" title="var">t_betaStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">app</span> (<span class="id" title="var">lambda</span> <span class="id" title="var">e</span>) <span class="id" title="var">v</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> 0 <span class="id" title="var">v</span>)))<br/>
.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">mkVal</span> (<span class="id" title="var">rv</span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">lock</span> -&gt; <span class="id" title="var">term</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
| <span class="id" title="var">mkLockedValid</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span>, <span class="id" title="var">rv</span> &gt;= <span class="id" title="var">oldV</span> -&gt; <span class="id" title="var">mkVal</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span>) <span class="id" title="var">v</span><br/>
| <span class="id" title="var">mkLockedInvalid</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span>, <span class="id" title="var">rv</span> &lt; <span class="id" title="var">oldV</span> -&gt; <span class="id" title="var">mkVal</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Locked</span> <span class="id" title="var">tid</span> <span class="id" title="var">oldV</span> <span class="id" title="var">v</span>) <span class="id" title="var">v'</span><br/>
| <span class="id" title="var">mkUnlocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">stamp</span> <span class="id" title="var">v</span>, <span class="id" title="var">mkVal</span> <span class="id" title="var">rv</span> (<span class="id" title="var">Unlocked</span> <span class="id" title="var">stamp</span>) <span class="id" title="var">v</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">readOrChkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">E</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span>, <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="var">log</span> <span class="id" title="var">b</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">chkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tail</span>, @<span class="id" title="var">readOrChkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">E</span> <span class="id" title="var">false</span> <span class="id" title="var">tail</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">tail</span>)<br/>
|<span class="id" title="var">nochkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tail</span>, @<span class="id" title="var">readOrChkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">E</span> <span class="id" title="var">true</span> <span class="id" title="var">tail</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">tail</span>).<br/>

<br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<a name="lab5"></a><h1 class="section">Replay Semantics</h1>


<div class="paragraph"> </div>

This is analogous to the <span class="inlinecode"><span class="id" title="var">trans_step</span></span> relation with the addition of the <span class="inlinecode"><span class="id" title="var">r_readStepInvalid</span></span> rule.  This allows us to maintain important invariants throughout the proofs later on.  The added rule allows us to read the backed up value of the location *if* the lock is acquired by someone else *and* the old version is valid with respect to our read version.  If this is not the case and the lock is invalid for us to read, then we are able to "pull a value out of thin air".

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">replay_step</span> : <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
<br/>
|<span class="id" title="var">r_readChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">S</span> (<span class="id" title="var">L</span> : <span class="id" title="var">log</span> <span class="id" title="var">false</span>) <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">v</span> <span class="id" title="var">e0</span> <span class="id" title="var">lock</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Chkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span>))<br/>
|<span class="id" title="var">r_readNoChkpnt</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">v</span> <span class="id" title="var">e0</span> <span class="id" title="var">lock</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">validStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> (<span class="id" title="var">Read</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">L</span>) (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span>))<br/>
|<span class="id" title="var">r_readStepInvalid</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">tid</span> <span class="id" title="var">E</span> <span class="id" title="var">H</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">e0</span> <span class="id" title="var">lock</span> <span class="id" title="var">v'</span> <span class="id" title="var">L'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">get</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>)) -&gt; <span class="id" title="var">mkVal</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> <span class="id" title="var">v'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">invalidStamp</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">lock</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">readOrChkpnt</span> <span class="id" title="var">l</span> <span class="id" title="var">v'</span> <span class="id" title="var">E</span> <span class="id" title="var">L</span> <span class="id" title="var">L'</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L'</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v'</span>))<br/>
|<span class="id" title="var">r_writeLocked</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">tid</span> <span class="id" title="var">E</span> <span class="id" title="var">l</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">v'</span> <span class="id" title="var">e0</span> <span class="id" title="var">H</span> <span class="id" title="var">lock</span> <span class="id" title="var">lock'</span> <span class="id" title="var">L'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">put</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>) <span class="id" title="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">Some</span>(<span class="id" title="var">v'</span>, <span class="id" title="var">lock</span>) -&gt; <span class="id" title="var">acquireLock</span> <span class="id" title="var">l</span> <span class="id" title="var">v'</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">lock</span> <span class="id" title="var">lock'</span> <span class="id" title="var">L'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) (<span class="id" title="var">update</span> <span class="id" title="var">H</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> <span class="id" title="var">lock'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">txThread</span> <span class="id" title="var">true</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L'</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">unit</span>))<br/>
|<span class="id" title="var">r_atomicIdemStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">atomic</span> <span class="id" title="var">e</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>))<br/>
|<span class="id" title="var">r_betaStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">H</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">app</span> (<span class="id" title="var">lambda</span> <span class="id" title="var">e</span>) <span class="id" title="var">v</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> 0 <span class="id" title="var">v</span>)))<br/>
.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">replay</span> : <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">replayRefl</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span>, <span class="id" title="var">replay</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span><br/>
|<span class="id" title="var">replayStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay_step</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt; <span class="id" title="var">replay</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span>.<br/>

<br/>
</div>

<div class="doc">
left recursive version of replay
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">rewind</span> : <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">rewindRefl</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span>, <span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span><br/>
|<span class="id" title="var">rewindStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt; <span class="id" title="var">replay_step</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">step_sig</span> := <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="keyword">Prop</span>.<br/>

<br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<a name="lab6"></a><h1 class="section">Common Step Semantics</h1>

This relation is parameterized by another step relation, allowing us to factor out the common rules into one relation, and then plug the unique rules (via c_liftedStep).  

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">c_liftedStep</span></span>: Dispatch to the parameterized step relation

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_transStep</span></span>: Take a transactional step

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_parLStep</span></span>: Focus on the left thread pool

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_parRStep</span></span>: Focus on the right thread pool

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_forkStep</span></span>: Fork a thread, use the version clock as the thread ID so we can preserve unique thread IDs

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_allocStep</span></span>: Allocate a new TVar.  This can only be done outside a transaction.  Allocation inside transactions presents a number of difficulties, mostly relating to alpha renaming.

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_commitStep</span></span>: Commit a transaction

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_atomicStep</span></span>: Begin a transaction.  Remember the current term in the event of a full abort.

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_betaStep</span></span>: Beta reduction outside a transction

</li>
<li> <span class="inlinecode"><span class="id" title="var">c_tsExtend</span></span>: Timestamp extension if log is valid.

</li>
</ul>

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">c_step</span> (<span class="id" title="var">st</span> : <span class="id" title="var">step_sig</span>) : <span class="id" title="var">step_sig</span> :=<br/>
|<span class="id" title="var">c_liftedStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">P</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">P'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">P</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">P'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">P</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">P'</span><br/>
|<span class="id" title="var">c_transStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span>, <span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span> <span class="id" title="var">t</span>) <span class="id" title="var">C</span> <span class="id" title="var">H'</span> (<span class="id" title="var">Single</span> <span class="id" title="var">t'</span>)<br/>
|<span class="id" title="var">c_parLStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T1'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T1'</span> -&gt; <span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>) <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1'</span> <span class="id" title="var">T2</span>)<br/>
|<span class="id" title="var">c_parRStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T2'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T2</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T2'</span> -&gt; <span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>) <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2'</span>)<br/>
|<span class="id" title="var">c_forkStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">tid</span> <span class="id" title="var">t</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">fork</span> <span class="id" title="var">e</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> <span class="id" title="var">t</span>)) (<span class="id" title="var">S</span> <span class="id" title="var">C</span>) <span class="id" title="var">H</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Par</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">unit</span>))) (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">C</span> <span class="id" title="var">e</span>)))<br/>
|<span class="id" title="var">c_allocStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">v</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span> <span class="id" title="var">l</span> <span class="id" title="var">tid</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> <span class="id" title="var">l</span> = <span class="id" title="var">None</span> -&gt; <span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">alloc</span> <span class="id" title="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> <span class="id" title="var">t</span>)) <span class="id" title="var">C</span> (<span class="id" title="var">update</span> <span class="id" title="var">H</span> <span class="id" title="var">l</span> <span class="id" title="var">v</span> (<span class="id" title="var">Unlocked</span> 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">loc</span> <span class="id" title="var">l</span>))))<br/>
|<span class="id" title="var">c_commitStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span> <span class="id" title="var">E</span> <span class="id" title="var">e0</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt; <span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">inatomic</span> <span class="id" title="var">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>)) (<span class="id" title="var">plus</span> 1 <span class="id" title="var">C</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HV</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">v</span>)))<br/>
|<span class="id" title="var">c_atomicStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">tid</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">atomic</span> <span class="id" title="var">e</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> <span class="id" title="var">t</span>)) (<span class="id" title="var">S</span> <span class="id" title="var">C</span>) <span class="id" title="var">H</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span>(<span class="id" title="var">inatomic</span> <span class="id" title="var">e</span>)) <span class="id" title="var">NilLog</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">inatomic</span> <span class="id" title="var">e</span>))))<br/>
|<span class="id" title="var">c_betaStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">tid</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> (<span class="id" title="var">app</span> (<span class="id" title="var">lambda</span> <span class="id" title="var">e</span>) <span class="id" title="var">v</span>) -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> <span class="id" title="var">t</span>)) <span class="id" title="var">C</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> (<span class="id" title="var">fill</span> <span class="id" title="var">E</span> (<span class="id" title="var">open</span> <span class="id" title="var">e</span> 0 <span class="id" title="var">v</span>))))<br/>
|<span class="id" title="var">c_tsExtend</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">S</span> <span class="id" title="var">L</span> <span class="id" title="var">e0</span> <span class="id" title="var">tid</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span> <span class="id" title="var">chkpnt</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">commit</span> <span class="id" title="var">chkpnt</span> <span class="id" title="var">HI</span> <span class="id" title="var">HV</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">c_step</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>)) (<span class="id" title="var">plus</span> 1 <span class="id" title="var">C</span>) <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">t</span>))<br/>
.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">p_step_</span> : <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">p_abortStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">L'</span> <span class="id" title="var">S</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> <span class="id" title="var">e</span> <span class="id" title="var">e0</span> <span class="id" title="var">e'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> (<span class="id" title="var">e'</span>, <span class="id" title="var">L'</span>) <span class="id" title="var">H'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">p_step_</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">plus</span> 1 <span class="id" title="var">C</span>) <span class="id" title="var">H'</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L'</span> <span class="id" title="var">e'</span>))<br/>
.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">f_step_</span> : <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="var">nat</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">pool</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">f_abortStep</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">L</span> <span class="id" title="var">L'</span> <span class="id" title="var">S</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> <span class="id" title="var">e</span> <span class="id" title="var">e0</span> <span class="id" title="var">e'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">validate</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">H</span> (<span class="id" title="var">abort</span> (<span class="id" title="var">e'</span>, <span class="id" title="var">L'</span>) <span class="id" title="var">H'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f_step_</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">plus</span> 1 <span class="id" title="var">C</span>) <span class="id" title="var">H'</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">C</span> <span class="id" title="var">e0</span> <span class="id" title="var">NilLog</span> <span class="id" title="var">e0</span>))<br/>
.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">p_step</span> := <span class="id" title="var">c_step</span> <span class="id" title="var">p_step_</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">f_step</span> := <span class="id" title="var">c_step</span> <span class="id" title="var">f_step_</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">multistep</span> (<span class="id" title="var">st</span> : <span class="id" title="var">step_sig</span>) : <span class="id" title="var">step_sig</span> :=<br/>
|<span class="id" title="var">c_multi_refl</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span>, <span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span><br/>
|<span class="id" title="var">c_multi_step</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt; <span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">multistep_rev</span> (<span class="id" title="var">st</span> : <span class="id" title="var">step_sig</span>) : <span class="id" title="var">step_sig</span> :=<br/>
|<span class="id" title="var">c_multi_rev_refl</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span>, <span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span><br/>
|<span class="id" title="var">c_multi_rev_step</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt; <span class="id" title="var">st</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> -&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">f_multistep</span> := <span class="id" title="var">multistep</span> <span class="id" title="var">f_step</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">p_multistep</span> := <span class="id" title="var">multistep</span> <span class="id" title="var">p_step</span>.<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">trans_multistep</span> : <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="var">heap</span> -&gt; <span class="id" title="var">thread</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">trans_refl</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span>, <span class="id" title="var">trans_multistep</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span><br/>
|<span class="id" title="var">trans_multi_step</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_step</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt; <span class="id" title="var">trans_multistep</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trans_multistep</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">ids</span> <span class="id" title="var">P</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">P</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Par</span> <span class="id" title="var">P1</span> <span class="id" title="var">P2</span> =&gt; <span class="id" title="var">Union</span> <span class="id" title="var">nat</span> (<span class="id" title="var">ids</span> <span class="id" title="var">P1</span>) (<span class="id" title="var">ids</span> <span class="id" title="var">P2</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">Single</span> (<span class="id" title="var">noTXThread</span> <span class="id" title="var">id</span> <span class="id" title="var">_</span>) =&gt; <span class="id" title="var">Singleton</span> <span class="id" title="var">nat</span> <span class="id" title="var">id</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Single</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">_</span> <span class="id" title="var">id</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) =&gt; <span class="id" title="var">Singleton</span> <span class="id" title="var">nat</span> <span class="id" title="var">id</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<a name="lab7"></a><h1 class="section">Pool Rewind</h1>


<div class="paragraph"> </div>

States that a pool of threads can rewind from where they are now in their transactions, to the beginning.  Non transactional threads stay where they are.  Additionally, it's helpful to know that the thread IDs are unique, so we pack that in here as well.

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">poolRewind</span> (<span class="id" title="var">C</span> : <span class="id" title="var">nat</span>) (<span class="id" title="var">H</span> : <span class="id" title="var">heap</span>) : <span class="id" title="var">pool</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">rewindSingleNoTX</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">tid</span> <span class="id" title="var">e</span>, <span class="id" title="var">tid</span> &lt; <span class="id" title="var">C</span> -&gt; <span class="id" title="var">poolRewind</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">noTXThread</span> <span class="id" title="var">tid</span> <span class="id" title="var">e</span>))<br/>
|<span class="id" title="var">rewindSingleInTX</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span> <span class="id" title="var">H'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H'</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">false</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">NilLog</span> <span class="id" title="var">e0</span>) <span class="id" title="var">H</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tid</span> &lt; <span class="id" title="var">C</span> -&gt; <span class="id" title="var">S</span> &lt; <span class="id" title="var">C</span> -&gt; <span class="id" title="var">poolRewind</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Single</span>(<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">tid</span> <span class="id" title="var">S</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>)) <br/>
|<span class="id" title="var">rewindPar</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Disjoint</span> <span class="id" title="var">nat</span> (<span class="id" title="var">ids</span> <span class="id" title="var">T1</span>) (<span class="id" title="var">ids</span> <span class="id" title="var">T2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">poolRewind</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> -&gt; <span class="id" title="var">poolRewind</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T2</span> -&gt; <span class="id" title="var">poolRewind</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>).<br/>

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">unique</span> (<span class="id" title="var">C</span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">pool</span> -&gt; <span class="id" title="keyword">Prop</span> :=<br/>
|<span class="id" title="var">SingletonNoTX</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">id</span> <span class="id" title="var">e</span>, <span class="id" title="var">id</span> &lt; <span class="id" title="var">C</span> -&gt; <span class="id" title="var">unique</span> <span class="id" title="var">C</span> (<span class="id" title="var">Single</span> (<span class="id" title="var">noTXThread</span> <span class="id" title="var">id</span> <span class="id" title="var">e</span>))<br/>
|<span class="id" title="var">SingletonTX</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">b</span> <span class="id" title="var">id</span> <span class="id" title="var">rv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>, <span class="id" title="var">id</span> &lt; <span class="id" title="var">C</span> -&gt; <span class="id" title="var">unique</span> <span class="id" title="var">C</span> (<span class="id" title="var">Single</span> (<span class="id" title="var">txThread</span> <span class="id" title="var">b</span> <span class="id" title="var">id</span> <span class="id" title="var">rv</span> <span class="id" title="var">e0</span> <span class="id" title="var">L</span> <span class="id" title="var">e</span>))<br/>
|<span class="id" title="var">ParUnique</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Disjoint</span> <span class="id" title="var">nat</span> (<span class="id" title="var">ids</span> <span class="id" title="var">T1</span>) (<span class="id" title="var">ids</span> <span class="id" title="var">T2</span>) -&gt; <span class="id" title="var">unique</span> <span class="id" title="var">C</span> <span class="id" title="var">T1</span> -&gt; <span class="id" title="var">unique</span> <span class="id" title="var">C</span> <span class="id" title="var">T2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unique</span> <span class="id" title="var">C</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>).<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multi_L</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">T1'</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> (<span class="id" title="var">c_step</span> <span class="id" title="var">st</span>) <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T1'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> (<span class="id" title="var">c_step</span> <span class="id" title="var">st</span>) <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>) <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1'</span> <span class="id" title="var">T2</span>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">T1'</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">HYP</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">HYP</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">constructor</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">econstructor</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">c_parLStep</span>. <span class="id" title="var">eassumption</span>. <span class="id" title="tactic">auto</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multi_R</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">T2'</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> (<span class="id" title="var">c_step</span> <span class="id" title="var">st</span>) <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T2</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T2'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> (<span class="id" title="var">c_step</span> <span class="id" title="var">st</span>) <span class="id" title="var">C</span> <span class="id" title="var">H</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span>) <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> (<span class="id" title="var">Par</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2'</span>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T1</span> <span class="id" title="var">T2</span> <span class="id" title="var">T2'</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">HYP</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">HYP</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">constructor</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">econstructor</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">c_parRStep</span>. <span class="id" title="var">eassumption</span>. <span class="id" title="var">eassumption</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">decomposeEq</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span> <span class="id" title="var">e</span>, <span class="id" title="var">decompose</span> <span class="id" title="var">t</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span> -&gt; <span class="id" title="var">t</span> = <span class="id" title="var">fill</span> <span class="id" title="var">E</span> <span class="id" title="var">e</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">E</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span>[<span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">simpl</span>;<span class="id" title="var">erewrite</span> &lt;- <span class="id" title="var">IHE</span>; <span class="id" title="tactic">eauto</span>].<br/>
&nbsp;&nbsp;{<span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">auto</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">lengthsEq</span> : <span class="id" title="keyword">forall</span> (<span class="id" title="var">A</span>:<span class="id" title="keyword">Type</span>) (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <span class="id" title="var">list</span> <span class="id" title="var">A</span>), <span class="id" title="var">x</span> = <span class="id" title="var">y</span> -&gt; <span class="id" title="var">length</span> <span class="id" title="var">x</span> = <span class="id" title="var">length</span> <span class="id" title="var">y</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">x</span>; <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">destruct</span> <span class="id" title="var">y</span>. <span class="id" title="tactic">auto</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">destruct</span> <span class="id" title="var">y</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">apply</span> <span class="id" title="tactic">f_equal</span>. <span class="id" title="tactic">auto</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">trans_replay</span>: <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span> -&gt; <span class="id" title="var">replay</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">replay</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> <span class="id" title="var">HYP1</span> <span class="id" title="var">HYP2</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">HYP2</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">auto</span>. <span class="id" title="tactic">econstructor</span>. <span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">rewindTrans</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> -&gt; <span class="id" title="var">rewind</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H''</span> <span class="id" title="var">t''</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">H''</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> <span class="id" title="var">HYP1</span> <span class="id" title="var">HYP2</span>. <span class="id" title="var">genDeps</span>{{<span class="id" title="var">H</span>; <span class="id" title="var">t</span>}}.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">HYP2</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">econstructor</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">IHHYP2</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">rewindIFFReplay</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rewind</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span> &lt;-&gt; <span class="id" title="var">replay</span> <span class="id" title="var">H</span> <span class="id" title="var">t</span> <span class="id" title="var">H'</span> <span class="id" title="var">t'</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">H</span> <span class="id" title="var">H'</span> <span class="id" title="var">t</span> <span class="id" title="var">t'</span>. <span class="id" title="tactic">split</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">HYP</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">induction</span> <span class="id" title="var">HYP</span>. <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">trans_replay</span>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">econstructor</span>. <span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">constructor</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">induction</span> <span class="id" title="var">HYP</span>. <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">rewindTrans</span>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">econstructor</span>; <span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">constructor</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multi_trans</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> <span class="id" title="var">HYP1</span> <span class="id" title="var">HYP2</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">HYP1</span>; <span class="id" title="tactic">auto</span>. <span class="id" title="tactic">econstructor</span>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multi_rev_trans</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> <span class="id" title="var">C''</span> <span class="id" title="var">H''</span> <span class="id" title="var">T''</span> <span class="id" title="var">HYP1</span> <span class="id" title="var">HYP2</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">HYP2</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">econstructor</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multistep_rev_forward</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt; <span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">H0</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">constructor</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">eapply</span> <span class="id" title="var">multi_rev_trans</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">c_multi_rev_step</span>. <span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">eauto</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multistep_rev_backward</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> -&gt; <span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">H0</span>.<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">constructor</span>. }<br/>
&nbsp;&nbsp;{<span class="id" title="tactic">eapply</span> <span class="id" title="var">multi_trans</span>. <span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">eapply</span> <span class="id" title="var">c_multi_step</span>. <span class="id" title="tactic">eauto</span>. <span class="id" title="tactic">constructor</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>

<br/>
<span class="id" title="keyword">Theorem</span> <span class="id" title="var">multistep_rev_eq</span> : <span class="id" title="keyword">forall</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">multistep</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span> &lt;-&gt; <span class="id" title="var">multistep_rev</span> <span class="id" title="var">st</span> <span class="id" title="var">C</span> <span class="id" title="var">H</span> <span class="id" title="var">T</span> <span class="id" title="var">C'</span> <span class="id" title="var">H'</span> <span class="id" title="var">T'</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">split</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">multistep_rev_forward</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">multistep_rev_backward</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>